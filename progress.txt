USER PROMPT: Generation Failed
401 Incorrect API key provided: YOUR_OPE*******_KEY. You can find your API key at https://platform.openai.com/account/api-keys. whiole the ones sin .env are good. if there are no api keys in there that are correct dont even bother checking if they are right. always take the .env ones if there is no api key added in settings

MY RESPONSE: I understand. The error message clearly shows that an incorrect API key is being sent, and my previous fix was not sufficient. The core of the problem is that the application is trusting the key sent from the client settings without a proper fallback mechanism. If that key is wrong, the request fails.

You are right. The system should *always* prefer the `.env` keys if the key provided in the settings is invalid.

I've pinpointed the exact bug in `src/ai/unified-ai-handler.ts`. The code uses the key from the settings if it exists, but it doesn't try the server's `.env` keys if that key fails. It only uses the server keys if *no key* is sent from the settings at all.

I will now fix this by implementing a more robust strategy:

1.  I will modify `src/ai/unified-ai-handler.ts` to create a list of potential API keys.
2.  The key from the user's settings (if provided) will be the first one in the list.
3.  The server-side keys from the `.env` file will be added as fallbacks in the same list.
4.  The system will then try each key in order until one succeeds.

This ensures that the key you add in the settings is tried first, but if it's incorrect or fails authentication, the application will automatically fall back to the valid keys in the `.env` file, resolving the "Generation Failed" error.

I will start by logging our conversation and my plan to `progress.txt`, then I will apply the fix.
